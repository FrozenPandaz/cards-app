<dom-module is="card-creator">
	<style>

		paper-material {
			padding: 20px;
			elevation: 2;
			display: inline-block;
			width: 100%;
			min-height: 80px;
		}
		h1 {
			display: inline-block;
			width: 6em;
		}
		form {
			position: relative;
			padding: 40px;
			display: block;
			float: right;
			width: 60%;
		}
		paper-toggle-button {
			float: right;
		}
		paper-button {
			position: relative;
			display: inline-block;
		}
		paper-input {
			display: inline-block;
		}
		custom-card {
			display: inline-block;
			float: left;
			margin-left: 20px;
		}

		@media (max-width: 600px) {
			h1 {
				width: 100%;
				text-align: center;
			}

			form {
				width: 80%;
			}
		}

	</style>
	<template>
		<firebase-document
			id="firebase"
			location="https://card-app.firebaseio.com/cards"
			data="{{data}}"></firebase-document>
		<paper-material>
			<h1>Submit your own Cards</h1><paper-button on-tap="clearCards">x</paper-button>
			<form is="iron-form" id="form" action="/" target="_self" on-iron-form-submit="submitForm" on-iron-form-reset="resetForm">
				<paper-toggle-button id="black" name="black" active="{{black}}"></paper-toggle-button>
				<paper-input auto-validate pattern={{pattern}} error-message={{error}} name="text" type="text" label="Card" value="{{cardText::input}}"></paper-input>
				<paper-button raised type="submit" on-tap="submitForm">Submit</paper-button>
			</form>
		</paper-material>
		<template is="dom-repeat" items="{{createdCards}}">
			<custom-card black$="{{item.black}}" card-text=[[item.text]]></custom-card>
		</template>
		<custom-card black$="{{black}}" card-text=[[cardText]]></custom-card>
	</template>
	<script>
		Polymer({
			is: 'card-creator',
			properties: {
				cardText: String,
				createdCards: {
					type: Array,
					value: [],
					notify: true
				},
				black: {
					type: Boolean,
					notify: true
				}, pattern: {
					type: String,
					computed: 'getPattern(black)',
					readOnly: true
				}, error: {
					type: String,
					computed: 'getError(black)',
					readOnly: true
				}
			},
			submitForm: function() {
				this.addCard(this.cardText, this.black ? 'black' : 'white');
				this.$.form.reset();
			},
			addCard: function(text, type) {
				var firebase = this.$.firebase,
					count = firebase.data[type].count,
					card = this.black ? {
						text: text,
						black: true,
						response_count: this.cardText.split(/_/).length - 1,
						stats: {
							play_count: 0
						}
					} : {
						text: text,
						black: false,
						stats: {
							draw_count: 0,
							play_count: 0,
							win_count: 0
						}
					};
				this.push('createdCards', card);
				firebase.query.child(type).child('count').set(count+1);
				firebase.query.child(type).child('card_'+(count+1)).set(card);
			},
			resetForm: function() {
				this.cardText = "";
			},
			getPattern: function(black) {
				return black ? '([^_]*_[^_]*){1,2}' : '^((?!_).)*$';
			},
			getError: function(black) {
				return black ? 'Black Cards must contain 1 or 2 fields("_")' : 'White Cards must not contain any "_"';
			},
			clearCards: function() {
				var type = this.black ? 'black' : 'white';
				this.$.firebase.query.child(type).set({count: 0});
			}
		})
	</script>
</dom-module>