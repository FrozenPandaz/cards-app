<dom-module is="card-creator">
	<style>

		paper-material {
			padding: 20px;
			elevation: 2;
			display: inline-block;
			width: 100%;
			min-height: 80px;
		}
		h1 {
			display: inline-block;
			width: 6em;
		}
		form {
			position: relative;
			margin-right: 40px;
			display: block;
			float: right;
		}
		paper-toggle-button {
			float: right;
		}
		paper-button {
			position: relative;
			display: inline-block;
		}
		paper-input {
			display: inline-block;
		}
		custom-card {
			display: inline-block;
			float: left;
			margin-left: 20px;
		}

	</style>
	<template>
		<firebase-document
			id="firebase"
			location="https://card-app.firebaseio.com/cards"
			data="{{data}}"></firebase-document>
		<paper-material>
			<h1>Submit your own Cards</h1>
			<form is="iron-form" id="form" action="/" target="_self">
				<paper-toggle-button id="black" name="black" active="{{black}}"></paper-toggle-button>
				<paper-input auto-validate pattern={{pattern}} error-message={{error}} name="text" type="text" label="Card" value="{{cardText::input}}"></paper-input>
				<paper-button raised type="submit">Submit</paper-button>
			</form>
		</paper-material>
			<custom-card black$="{{black}}" card-text=[[cardText]]>
			</custom-card>
	</template>
	<script>
		Polymer({
			is: 'card-creator',
			properties: {
				cardText: String,
				black: {
					type: Boolean,
					notify: true
				}, pattern: {
					type: String,
					computed: 'getPattern(black)',
					readOnly: true
				}, error: {
					type: String,
					computed: 'getError(black)',
					readOnly: true
				}
			},
			ready: function() {
				var form =this.$.form,
					_this = this;
				form.addEventListener('iron-form-submit', function() {
					_this.submitForm();
				});
			},
			submitForm: function() {
				console.log('submit form');
				var type = this.black ? 'black' : 'white',
					firebase = this.$.firebase,
					count = firebase.data[type].count,
					card = this.black ? {
						text: this.cardText,
						response_count: this.cardText.split(/_/).length - 1,
						stats: {
							play_count: 0
						}
					} : {
						text: this.cardText,
						stats: {
							draw_count: 0,
							play_count: 0,
							win_count: 0
						}
					} ;
				firebase.query.child(type).child('count').set(count+1);
				firebase.query.child(type).child('card_'+(count+1)).set(card);
			},
			getPattern: function(black) {
				return black ? '([^_]*_[^_]*){1,2}' : '^((?!_).)*$';
			},
			getError: function(black) {
				return black ? 'Black Cards must contain 1 or 2 fields("_")' : 'White Cards must not contain any "_"';
			}
		})
	</script>
</dom-module>