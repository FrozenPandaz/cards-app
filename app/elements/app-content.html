<dom-module is="app-content">
	<style>
		custom-card {
			position: relative;
			float: right;
			margin-right: 20px;
			margin-top: 20px;
		}
	</style>
	<template>
		<firebase-document
			id="game_firebase"
			location$="{{url}}"
			data="{{game_data}}"></firebase-document>
		<firebase-collection
			id="user_firebase"
			location$="{{user_url}}"
			data="{{users}}"></firebase-collection>
		<iron-localstorage
			name="{{game}}"
			value="{{user_data}}"></iron-localstorage>
		
		<paper-material>
			<ol>
				<template is="dom-repeat" items="{{users}}" filter="notCount" sort="byScore">
					<li>{{item.name}} : {{item.score}}</li>
				</template>
			</ol>
		</paper-material>

		<paper-dialog id="start">
			<paper-button on-tap="startGame">Start Game</paper-button>
		</paper-dialog>

		<paper-dialog id="prompt">
			<h1>Welcome to {{game_data.name}}!</h1>
			<form is="iron-form" on-iron-form-submit="newUser">
				<paper-input label="What is your name?" value="{{name::input}}">
				</paper-input>
			</form>
		</paper-dialog>
		<custom-card black card-text="This is text."></custom-card>
	</template>
	<script>
		AppContent = Polymer({
			is: "app-content",
			properties: {
				game: {
					type: String,
					notify: true
				},
				game_data: {
					type: Object,
					notify: true
				},
				name: String,
				user_data: Object,
				url: {
					type: String,
					computed: 'getUrl(game)',
					notify: true
				},
				user_url: {
					type: String,
					computed: 'getUserUrl(url)'
				},
				gameStarted: {
					type: Boolean,
					computed: 'isGameStarted()'
				}
			},
			observers: [
				'onGameStartedChange(game_data.started)'
			],
			onGameStartedChange: function(started) {
				this.fire('game-started');
			},
			isGameStarted: function() {
				return this.$.game_firebase.data.started === true;
			},
			startGame: function() {
				var black = {
						total: 0,
						deck: [],
						copy: []
					},
					white = {
						total: 0,
						deck: [],
						copy: []
					},
					rand_pos;
				(new Firebase("https://card-app.firebaseio.com/cards/")).once('value', function(snapshot) {
					for (var card in snapshot.child('white').val()) {
						if (card !== "count" && card !== 'existingCards') {
							white.copy.push(card);
						}
					}
					for (var card in snapshot.child('black').val()) {
						if (card !== "count" && card !== 'existingCards') {
							black.copy.push(card);
						}
					}
				});

				white.total = white.copy.length;
				black.total = black.copy.length;
				while (white.total > 0) {
					rand_pos = Math.floor(Math.random()*white.total--);
					white.deck.push(white.copy.splice(rand_pos,1)[0]);
				}

				while (black.total > 0) {
					rand_pos = Math.floor(Math.random()*black.total--);
					black.deck.push(black.copy.splice(rand_pos,1)[0]);
				}


				this.$.game_firebase.query.update({started: new Date().getTime(), deckWhite: white.deck, deckBlack: black.deck});
				this.$.start.close();
			},
			attached: function() {
				var _this = this;
				setTimeout(function() {
					if (!_this.user_data) {
						_this.$.prompt.open();
					}
				}, 200);
				this.$.start.open();
			},
			newUser: function() {
				var count = this.$.game_firebase.data.users.count || 0,
					user_id = 'user_' + count,
					new_data = {
						count: count + 1
					};
				this.user_data = {
					id: user_id,
					name: this.name
				};
				new_data[user_id] = {
					name: this.name,
					score: 0
				};
				this.$.user_firebase.query.update(new_data);
				this.$.prompt.close();
				this.$.start.open();
			},
			getPoints: function(user_id) {
				return this.$.user_firebase.data[user_id].score;
			},
			addPoints: function(user_id, point) {
				point = point || 1;
				this.$.user_firebase.query.child(user_id).child('score').set(getScore(user_id) + 1);
			},
			byScore: function(a, b) {
				return a.score > b.score;
			},
			notCount: function(item) {
				return item.__firebaseKey__ !== "count";
			},
			getUrl: function(game) {
				return "https://card-app.firebaseio.com/games/" + game;
			},
			getUserUrl: function(url) {
				return url  + "/users";
			},
			promptForUser: function() {
				this.$.prompt.open();
			}
		});
	</script>
</dom-module>